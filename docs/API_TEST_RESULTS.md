# API æœåŠ¡æµ‹è¯•ç»“æœ

æµ‹è¯•æ—¶é—´ï¼š2025-12-25
æœåŠ¡å™¨åœ°å€ï¼šhttp://127.0.0.1:8000
æµ‹è¯•ç´¢å¼•ï¼šdata/index_test (500 æ ·æœ¬)

**æ›´æ–°**: æ–°å¢æ··åˆæ£€ç´¢ (Hybrid Search) æµ‹è¯•

## âœ… æµ‹è¯•é€šè¿‡çš„ç«¯ç‚¹

### 1. æ ¹ç«¯ç‚¹ `GET /`

**è¯·æ±‚ï¼š**
```bash
curl http://127.0.0.1:8000/
```

**å“åº”ï¼š**
```json
{
    "message": "CAD Vector Database API",
    "version": "1.0.0",
    "endpoints": [
        "/search",
        "/stats",
        "/vectors/{id}"
    ]
}
```

**çŠ¶æ€ï¼š** âœ… é€šè¿‡

---

### 2. ç»Ÿè®¡ä¿¡æ¯ç«¯ç‚¹ `GET /stats`

**è¯·æ±‚ï¼š**
```bash
curl http://127.0.0.1:8000/stats
```

**å“åº”ï¼š**
```json
{
    "total_vectors": 500,
    "index_type": "HNSW",
    "feature_dim": 32,
    "index_params": {
        "hnsw_m": 32,
        "hnsw_ef_search": 128,
        "normalized": true
    }
}
```

**çŠ¶æ€ï¼š** âœ… é€šè¿‡

---

### 3. æœç´¢ç«¯ç‚¹ `POST /search`

**è¯·æ±‚ï¼š**
```bash
curl -X POST "http://127.0.0.1:8000/search" \
  -H "Content-Type: application/json" \
  -d '{
    "query_file_path": "/Users/he.tian/bs/WHUCAD-main/data/vec/0000/00000001.h5",
    "k": 5,
    "stage1_topn": 20,
    "fusion_method": "weighted"
  }'
```

**å“åº”ï¼ˆTop-5 ç»“æœï¼‰ï¼š**
```json
[
    {
        "id": "0000/00000001.h5",
        "score": 1.0000000238418578,
        "sim_stage1": 1.0,
        "sim_stage2": 1.0,
        "metadata": {
            "id": "0000/00000001.h5",
            "file_path": "/Users/he.tian/bs/WHUCAD-main/data/vec/0000/00000001.h5",
            "subset": "0000",
            "seq_len": 20
        }
    },
    {
        "id": "0000/00000235.h5",
        "score": 0.3844168617270893,
        "sim_stage1": 0.6393846273422241,
        "sim_stage2": 0.001965198403225878,
        "metadata": {
            "id": "0000/00000235.h5",
            "file_path": "/Users/he.tian/bs/WHUCAD-main/data/vec/0000/00000235.h5",
            "subset": "0000",
            "seq_len": 29
        }
    },
    {
        "id": "0000/00000491.h5",
        "score": 0.37408892441364444,
        "sim_stage1": 0.6224347949028015,
        "sim_stage2": 0.0015700888775864329,
        "metadata": {
            "id": "0000/00000491.h5",
            "file_path": "/Users/he.tian/bs/WHUCAD-main/data/vec/0000/00000491.h5",
            "subset": "0000",
            "seq_len": 14
        }
    },
    {
        "id": "0000/00000340.h5",
        "score": 0.3382771789361425,
        "sim_stage1": 0.5625280141830444,
        "sim_stage2": 0.0019009111646284466,
        "metadata": {
            "id": "0000/00000340.h5",
            "file_path": "/Users/he.tian/bs/WHUCAD-main/data/vec/0000/00000340.h5",
            "subset": "0000",
            "seq_len": 22
        }
    },
    {
        "id": "0000/00000109.h5",
        "score": 0.3143377179682784,
        "sim_stage1": 0.5232963562011719,
        "sim_stage2": 0.0008997010142934698,
        "metadata": {
            "id": "0000/00000109.h5",
            "file_path": "/Users/he.tian/bs/WHUCAD-main/data/vec/0000/00000109.h5",
            "subset": "0000",
            "seq_len": 15
        }
    }
]
```

**çŠ¶æ€ï¼š** âœ… é€šè¿‡

**å…³é”®è§‚å¯Ÿï¼š**
- âœ… è‡ªåŒ¹é…å¾—åˆ†å®Œç¾ï¼š1.0ï¼ˆstage1: 1.0, stage2: 1.0ï¼‰
- âœ… èåˆåˆ†æ•°åˆç†ï¼š0.31-0.38ï¼ˆstage1 å’Œ stage2 çš„åŠ æƒå¹³å‡ï¼‰
- âœ… è¿”å›å®Œæ•´çš„å…ƒæ•°æ®ä¿¡æ¯
- âœ… å“åº”æ—¶é—´å¿«é€Ÿï¼ˆ< 100msï¼‰

---

### 3.5 æ··åˆæ£€ç´¢ç«¯ç‚¹ `POST /search` (å¸¦å…ƒæ•°æ®è¿‡æ»¤)

**åŠŸèƒ½ï¼š** åœ¨å‘é‡æ£€ç´¢å‰ï¼Œå…ˆæ ¹æ®å…ƒæ•°æ®æ¡ä»¶ï¼ˆå­é›†ã€åºåˆ—é•¿åº¦ç­‰ï¼‰è¿‡æ»¤å€™é€‰é›†

#### æµ‹è¯•ç”¨ä¾‹ 1: å­é›†è¿‡æ»¤

**è¯·æ±‚ï¼š**
```bash
curl -X POST http://127.0.0.1:8000/search \
  -H "Content-Type: application/json" \
  -d '{
    "query_file_path": "/Users/he.tian/bs/WHUCAD-main/data/vec/0000/00000000.h5",
    "k": 5,
    "stage1_topn": 50,
    "filters": {
      "subset": "0000"
    }
  }'
```

**å“åº”æ‘˜è¦ï¼š**
```json
[
  {
    "id": "0000/00000000.h5",
    "score": 1.0,
    "metadata": {"subset": "0000", "seq_len": 7}
  },
  {
    "id": "0000/00000498.h5",
    "score": 0.651,
    "metadata": {"subset": "0000", "seq_len": 7}
  },
  ...
]
```

**éªŒè¯ï¼š** âœ… æ‰€æœ‰ç»“æœçš„ `subset` éƒ½æ˜¯ `"0000"`

#### æµ‹è¯•ç”¨ä¾‹ 2: å­é›† + åºåˆ—é•¿åº¦èŒƒå›´è¿‡æ»¤

**è¯·æ±‚ï¼š**
```bash
curl -X POST http://127.0.0.1:8000/search \
  -H "Content-Type: application/json" \
  -d '{
    "query_file_path": "/Users/he.tian/bs/WHUCAD-main/data/vec/0000/00000000.h5",
    "k": 5,
    "stage1_topn": 50,
    "filters": {
      "subset": "0000",
      "min_seq_len": 8,
      "max_seq_len": 10
    }
  }'
```

**å“åº”æ‘˜è¦ï¼š**
```json
[
  {
    "id": "0000/00000334.h5",
    "score": 0.918,
    "metadata": {"subset": "0000", "seq_len": 10}
  },
  {
    "id": "0000/00000113.h5",
    "score": 0.792,
    "metadata": {"subset": "0000", "seq_len": 10}
  },
  {
    "id": "0000/00000391.h5",
    "score": 0.716,
    "metadata": {"subset": "0000", "seq_len": 8}
  },
  ...
]
```

**éªŒè¯ï¼š** âœ… æ‰€æœ‰ç»“æœæ»¡è¶³ `subset="0000"` ä¸” `8 <= seq_len <= 10`

#### å¯¹æ¯”æµ‹è¯•ï¼šæ— è¿‡æ»¤ vs æœ‰è¿‡æ»¤

| åœºæ™¯ | Top-1 ç»“æœ | Top-5 seq_len åˆ†å¸ƒ |
|------|-----------|-------------------|
| æ— è¿‡æ»¤ | 0000/00000000.h5 (è‡ªåŒ¹é…) | 7, 7, 7, 10, 8 |
| subset=0000 | 0000/00000000.h5 (è‡ªåŒ¹é…) | 7, 7, 7, 10, 8 |
| subset=0000 + seq_len 8-10 | 0000/00000334.h5 (ä¸åŒæ–‡ä»¶) | 10, 10, 10, 10, 8 |

**å…³é”®å‘ç°ï¼š**
- âœ… è¿‡æ»¤å™¨æˆåŠŸæ’é™¤äº† `seq_len=7` çš„ç»“æœ
- âœ… æŸ¥è¯¢æ–‡ä»¶æœ¬èº« (seq_len=7) ä¸ç¬¦åˆæ¡ä»¶ï¼Œè¢«è¿‡æ»¤æ‰
- âœ… è¿”å›çš„ç»“æœéƒ½æ˜¯ç›¸ä¼¼ä¸”ç¬¦åˆä¸šåŠ¡æ¡ä»¶çš„å‘é‡

**çŠ¶æ€ï¼š** âœ… æ··åˆæ£€ç´¢é€šè¿‡æ‰€æœ‰æµ‹è¯•

**æ€§èƒ½ï¼š**
- å€™é€‰é›†è¿‡æ»¤é€Ÿåº¦ï¼š< 5ms
- æ€»ä½“å“åº”æ—¶é—´ï¼š35-50msï¼ˆä¸æ— è¿‡æ»¤ç›¸å½“æˆ–æ›´å¿«ï¼‰

---

### 4. å‘é‡å…ƒæ•°æ®ç«¯ç‚¹ `GET /vectors/{id}`

**è¯´æ˜ï¼š** è¯¥ç«¯ç‚¹å­˜åœ¨è·¯å¾„å‚æ•°è§£æé—®é¢˜ï¼Œéœ€è¦ä¿®å¤ã€‚

**é—®é¢˜ï¼š** FastAPI é»˜è®¤ä¸æ”¯æŒè·¯å¾„å‚æ•°ä¸­çš„æ–œæ  `/`ï¼Œéœ€è¦ä½¿ç”¨ `{vector_id:path}` å£°æ˜ã€‚

**å·²ä¿®å¤ï¼š** ä»£ç å·²æ›´æ–°ä¸º `@app.get("/vectors/{vector_id:path}")`

**çŠ¶æ€ï¼š** âš ï¸ å·²ä¿®å¤ä½†æœªé‡æ–°æµ‹è¯•

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| ç´¢å¼•åŠ è½½æ—¶é—´ | ~2-3ç§’ |
| å•æ¬¡æœç´¢å»¶è¿Ÿï¼ˆæ— è¿‡æ»¤ï¼‰ | ~50-100ms |
| å•æ¬¡æœç´¢å»¶è¿Ÿï¼ˆæœ‰è¿‡æ»¤ï¼‰ | ~35-50ms |
| å…ƒæ•°æ®è¿‡æ»¤è€—æ—¶ | < 5ms |
| Top-5 è¿”å›å¤§å° | ~1.2KB |
| å¹¶å‘èƒ½åŠ› | æœªæµ‹è¯• |

---

## ğŸ”§ å·²çŸ¥é—®é¢˜

1. **DeprecationWarning**: `on_event` å·²å¼ƒç”¨
   - å½±å“ï¼šä»…è­¦å‘Šï¼Œä¸å½±å“åŠŸèƒ½
   - è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ lifespan event handlers
   - ä¼˜å…ˆçº§ï¼šä½

2. **å‘é‡å…ƒæ•°æ®ç«¯ç‚¹è·¯å¾„å‚æ•°**
   - å½±å“ï¼šæ— æ³•é€šè¿‡ ID è·å–å…ƒæ•°æ®
   - è§£å†³æ–¹æ¡ˆï¼šå·²ä¿®å¤ï¼Œä½¿ç”¨ `{vector_id:path}`
   - ä¼˜å…ˆçº§ï¼šä¸­
   - çŠ¶æ€ï¼šå·²ä¿®å¤ï¼Œå¾…éªŒè¯

---

## ğŸ¯ æµ‹è¯•æ€»ç»“

### é€šè¿‡çš„åŠŸèƒ½ âœ…
- [x] æœåŠ¡å™¨å¯åŠ¨å’Œç´¢å¼•åŠ è½½
- [x] æ ¹ç«¯ç‚¹è¿”å› API ä¿¡æ¯
- [x] ç»Ÿè®¡ä¿¡æ¯ç«¯ç‚¹
- [x] æœç´¢ç«¯ç‚¹ï¼ˆä¸¤é˜¶æ®µæ£€ç´¢ + èåˆï¼‰
- [x] æ··åˆæ£€ç´¢ï¼ˆå…ƒæ•°æ®è¿‡æ»¤ + å‘é‡æ£€ç´¢ï¼‰
  - [x] å­é›†è¿‡æ»¤
  - [x] åºåˆ—é•¿åº¦èŒƒå›´è¿‡æ»¤
  - [x] å¤šæ¡ä»¶ç»„åˆè¿‡æ»¤
- [x] è‡ªåŒ¹é…éªŒè¯ï¼ˆå®Œç¾å¾—åˆ† 1.0ï¼‰
- [x] å…ƒæ•°æ®è¿”å›å®Œæ•´

### å¾…éªŒè¯çš„åŠŸèƒ½ â¸ï¸
- [ ] å‘é‡å…ƒæ•°æ®ç«¯ç‚¹ï¼ˆå·²ä¿®å¤ï¼Œéœ€é‡å¯éªŒè¯ï¼‰
- [ ] ä¸åŒèåˆæ–¹æ³•ï¼ˆRRF, Bordaï¼‰
- [ ] ä¸åŒå‚æ•°ç»„åˆ
- [ ] é”™è¯¯å¤„ç†ï¼ˆæ— æ•ˆæ–‡ä»¶è·¯å¾„ç­‰ï¼‰
- [ ] å¹¶å‘æ€§èƒ½æµ‹è¯•

### æµ‹è¯•ç»“è®º
**âœ… API æœåŠ¡æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸ï¼Œå¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼**

æœç´¢åŠŸèƒ½å®Œæ•´ï¼Œä¸¤é˜¶æ®µæ£€ç´¢å’Œèåˆæ’åºå·¥ä½œæ­£å¸¸ï¼Œå“åº”é€Ÿåº¦å¿«ï¼Œè¿”å›ç»“æœå‡†ç¡®ã€‚

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### Python å®¢æˆ·ç«¯ç¤ºä¾‹

```python
import requests
import json

# æœåŠ¡å™¨åœ°å€
BASE_URL = "http://127.0.0.1:8000"

# 1. è·å–ç»Ÿè®¡ä¿¡æ¯
stats = requests.get(f"{BASE_URL}/stats").json()
print(f"Total vectors: {stats['total_vectors']}")
print(f"Index type: {stats['index_type']}")

# 2. æœç´¢ç›¸ä¼¼å‘é‡
search_request = {
    "query_file_path": "/Users/he.tian/bs/WHUCAD-main/data/vec/0000/00000001.h5",
    "k": 10,
    "stage1_topn": 50,
    "fusion_method": "weighted",
    "alpha": 0.6,
    "beta": 0.4
}

results = requests.post(f"{BASE_URL}/search", json=search_request).json()

print(f"\nTop-10 æœç´¢ç»“æœ:")
for i, result in enumerate(results, 1):
    print(f"{i}. {result['id']}")
    print(f"   å¾—åˆ†: {result['score']:.4f}")
    print(f"   Stage1: {result['sim_stage1']:.4f}, Stage2: {result['sim_stage2']:.4f}")
    print(f"   åºåˆ—é•¿åº¦: {result['metadata']['seq_len']}")
```

### JavaScript/Fetch ç¤ºä¾‹

```javascript
// è·å–ç»Ÿè®¡ä¿¡æ¯
fetch('http://127.0.0.1:8000/stats')
  .then(res => res.json())
  .then(data => console.log('Stats:', data));

// æœç´¢
fetch('http://127.0.0.1:8000/search', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    query_file_path: '/Users/he.tian/bs/WHUCAD-main/data/vec/0000/00000001.h5',
    k: 5,
    fusion_method: 'weighted'
  })
})
  .then(res => res.json())
  .then(results => {
    console.log('Top-5 Results:');
    results.forEach((r, i) => {
      console.log(`${i+1}. ${r.id} - Score: ${r.score.toFixed(4)}`);
    });
  });
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

1. **é‡å¯æœåŠ¡éªŒè¯ä¿®å¤**
   - éªŒè¯å‘é‡å…ƒæ•°æ®ç«¯ç‚¹
   - æµ‹è¯•ä¸åŒèåˆæ–¹æ³•

2. **å‹åŠ›æµ‹è¯•**
   - å¹¶å‘è¯·æ±‚æµ‹è¯•
   - å¤§æ‰¹é‡æŸ¥è¯¢æµ‹è¯•

3. **é”™è¯¯å¤„ç†æµ‹è¯•**
   - æ— æ•ˆæ–‡ä»¶è·¯å¾„
   - å‚æ•°è¾¹ç•Œå€¼

4. **æ–‡æ¡£å®Œå–„**
   - OpenAPI æ–‡æ¡£ä¼˜åŒ–
   - æ·»åŠ æ›´å¤šç¤ºä¾‹

5. **éƒ¨ç½²å‡†å¤‡**
   - Docker åŒ–
   - æ·»åŠ æ—¥å¿—
   - é…ç½®ç®¡ç†
